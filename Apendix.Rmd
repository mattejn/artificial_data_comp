---
title: "Masters Thesis Apendix"
author: "Matej Nemec"
date: "4/22/2022"
output: html_document
---

# Intro

This document serves as supplementary material for my thesis demonstrating some of the scripting done to achieve the presented results. It should allow anyone to reproduce the data and evaluate the results for themselves.

# Setup

## Load libraries, set working directory and seed

```{r setup,results='hide'}
knitr::opts_chunk$set(echo = TRUE)
library('flowCore')
library("rjson")
library('nougad')
library('flowWorkspace')
library('FNN')
library('ggplot2')
library('EmbedSOM')
library('gridExtra')
library('cowplot')
library('nougadmt')
library('ggpubr')
library('scales')
library('parallel')
library('ggsci')
set.seed(42)
```


Set working directory to the location of this notebook.
```{r wd}
try({
  dr = getSrcDirectory()[1]
})
#when sourcing the file
try({
  dr = dirname(rstudioapi::getActiveDocumentContext()$path)
})
#for running code directly in rstudio
setwd(dr) #set for usage as a script/running lines
knitr::opts_knit$set(root.dir = dr) #set for R markdown chunk execution
```

## Define functions

```{r fncs}
trans = function(x)
  asinh(x / 10)
norm = function(x)
  (x - min(x)) / (max(x) - min(x))
recur_unpack = function(pars, df, todel) {
  par_rows = df[df$pop %in% pars, ]
  new_pars = c()
  for (r in 1:nrow(par_rows)) {
    if (par_rows[r, 'pop'] %in% df[, 'parent_pop']) {
      par_row = par_rows[r, ]
      children_rows = df[df$parent_pop == par_row$pop, ]
      children_rows$relative_cnt = children_rows$relative_cnt * par_row$relative_cnt
      for (i in 1:nrow(children_rows)) {
        for (k in 1:ncol(children_rows)) {
          #there is definitely a way to do this better
          if (is.na(children_rows[i, k])) {
            children_rows[i, k] = par_row[1, k]
          }
        }
      }
      df[rownames(children_rows), ] = children_rows
      children = children_rows$pop
      for (child in children) {
        if (nrow(df[df$parent_pop %in% child, ]) != 0) {
          new_pars = c(new_pars, child)
        }
        todel = c(todel, as.integer(rownames(par_row)))
      }
    }
    if (r == nrow(par_rows) &&
        length(new_pars) == 0) {
      return(df[-unique(todel), ])
    }
  }
  recur_unpack(new_pars, df, todel)
}
generate_artificial_cytometry_data = function(spectra, pheno, n, stronk, uncertainty=1) {
  #Generate some portion of dead cells for each of the phenotypes
  n_pheno = nrow(pheno)
  pheno[is.na(pheno)] = 0
  rownames(pheno) = paste0(pheno$parent_pop, pheno$pop)
  bkp = rownames(pheno)
  pheno$relative_cnt = pheno$relative_cnt * (1 / sum(pheno$relative_cnt))
  counts_pheno = pheno$relative_cnt
  pheno = pheno[, -c(1:3)]
  dead = pheno #duplicate
  rownames(dead) = paste0(rep('dead_', n_pheno), rownames(pheno))
  pheno[, 'LIVE DEAD Blue'] = rep(0, n_pheno) #LD expr for live cells is ~0
  pheno = pheno[, rownames(spectra)]
  cnts_dead = counts_pheno * runif(n_pheno, 0.1, 0.25) #amount of dead cells for each phenotype 10-25%
  cnts_dead = cnts_dead / sum(cnts_dead)
  
  #Generate probability matrices separately for live and dead cells
  spectra = spectra / sqrt(rowSums(spectra ^ 2)) #normalize spectra to unit vector(magnitude=1) this is already done if spectra from panelbuilder
  d = ncol(spectra) #number of detectors
  exp_prob_mtx_normal = pheno[rep(1:n_pheno , round(counts_pheno * n *
                                                      0.825)), ]
 exp_prob_mtx_dead = dead[rep(1:n_pheno , round(cnts_dead * n * 0.175)), ]#maybe LD expression should increase(complement) with how dead the cells are - eq. with decrease in expr proportion increase LD expr.
  dead_exp=runif(nrow(exp_prob_mtx_dead), 0.3, 0.6)
  exp_prob_mtx_dead = exp_prob_mtx_dead * dead_exp #expression magnitude for dead cells 30-60%
  dead_exp = (1-dead_exp) + runif(nrow(exp_prob_mtx_dead), 0.3, 0.5)#LD expr for dead cells 60-100%
  dead_exp[dead_exp>1]=1
  exp_prob_mtx_dead[, 'LIVE DEAD Blue']=dead_exp
  exp_prob_mtx_dead = exp_prob_mtx_dead[, rownames(spectra)]
  full_prob_mtx = rbind(exp_prob_mtx_normal, exp_prob_mtx_dead)
  
  #Appropriately amplify the expression of strong markers
  nr = nrow(full_prob_mtx) #get the actual number of cells (probably !=n because of rounding)
  weak = (1:ncol(full_prob_mtx))[!(1:ncol(full_prob_mtx) %in% stronk)]
  k_stronk = length(stronk)
  k_weak = nrow(spectra) - k_stronk
  
  #Generate expression abundance matrix from probability matrices
  exprs_stronk =
    10 ^ ((4-uncertainty) + uncertainty * (matrix(
      rbinom(nr * k_stronk, 1, as.matrix(full_prob_mtx[, stronk])), nr, k_stronk
    ) + rnorm(nr * k_stronk, sd = 0.2)))
  exprs_weak =
    10 ^ (2 + 2 * (matrix(
      rbinom(nr * k_weak, 1, as.matrix(full_prob_mtx[, weak])), nr, k_weak
    ) + rnorm(nr * k_weak, sd = 0.2)))
  exprs = matrix(,
                 nrow = nrow(full_prob_mtx),
                 ncol = ncol(full_prob_mtx))
  exprs[, stronk] = exprs_stronk
  exprs[, weak] = exprs_weak
  rownames(exprs) = rownames(full_prob_mtx)
  
  #Add expression based noise
  gt = exprs #expression matrix at this stage is our ground truth -> actual abundances with no noise
  for (row in nrow(exprs)) {
    #add noise based on total expression magnitude for each cell -> represents increase in scattering/diffraction/interference
    exprs[row, ] = exprs[row, ] + rnorm(ncol(exprs), sd = sum(exprs[row, ]) *
                                          0.001)# with increase in total target expression indirectly causing fluorochromes
  }#to emit into neighbouring channels even though they are outside of their standard emission spectrum
  colnames(exprs) = colnames(full_prob_mtx) #keep detector names
  rm(full_prob_mtx)
  
  #create the emission specta
  emitted = exprs %*% spectra
  
  #add emission based noise
  received = emitted + rnorm(length(emitted), sd = 0.0005 * sqrt(rowSums(emitted ^
                                                                           2)))#add noise dependent on total fluorescent power -> sd depends on total energy
  rm(emitted)#and therefore results in higher noise in dimmer channels
  colnames(gt) = rownames(spectra)
  return(list(received, gt, nr))
  
}
get_data_struct = function(spectra, pheno, n, stronk) {
  data = generate_artificial_cytometry_data(spectra, pheno, n, stronk)
  res = list()
  spec_nms = row.names(spectra)
  nspectra = nrow(spectra)
  res[['received']] = data[[1]]
  res[['gt_trans']] = as.data.frame(trans(data[[2]]))
  colnames(res[['gt_trans']]) = spec_nms
  res[['n']] = data[[3]]
  rm(data)
  res[['cell_brightness']] = rowSums(res[['received']])
  res[['ngd']] = list()
  res[['ngd']][['unmix_trans']] = as.data.frame(trans(
    nougadmt(
      res[['received']],
      spectra = spectra,
      snw = 11, #55
      spw = 105, #261
      nw = 358, #1905
      start = 66, #91
      iters = 500, 
      alpha = 0.015, #0.00272
      accel=0.085, #0.338
      nthreads = detectCores()
    )$unmixed
  ))
  res[['ols']] = list()
  res[['ols']][['unmix_trans']] = as.data.frame(trans(t(lm(
    t(res[['received']]) ~ t(spectra) + 0
  )$coefficients)))
  res[['wols']] = list()
  res[['wols']][['unmix_trans']] = res[['ols']][['unmix_trans']]
  for (i in 1:res[['n']]) {
    ws = norm(pmax(0, res[['received']][i, ] / sum(res[['received']][i, ])))
    res[['wols']][['unmix_trans']][i, ] = trans(t(lm(t(res[['received']][i, , drop = F]) ~ t(spectra) + 0, weights =
                                                       ws)$coefficients))
  }
  for (toclamp in c('ngd', 'wols', 'ols'))
  {
    clp = paste0('zeroclamp_', toclamp)
    res[[clp]] = list()
    res[[clp]][['unmix_trans']] = as.data.frame(res[[toclamp]][['unmix_trans']])
    res[[clp]][['unmix_trans']][res[[clp]][['unmix_trans']] < 0] = 0
  }
  for (method in c('ngd',
                   'ols',
                   'wols',
                   'zeroclamp_ngd',
                   'zeroclamp_ols',
                   'zeroclamp_wols')) {
    res[[method]][['sq_err']] = as.data.frame((res[[method]][['unmix_trans']] - res[['gt_trans']]) ^
                                                2)
    colnames(res[[method]][['sq_err']]) = spec_nms
    res[[method]][['mean_cell_err']] = rowSums(res[[method]][['sq_err']]) /
      nspectra
    res[[method]][['mean_spec_err']] = colSums(res[[method]][['sq_err']]) /
      res[['n']]
    res[[method]][['mse']] = sum(res[[method]][['sq_err']]) / (res[['n']] *
                                                                 nspectra)
    colnames(res[[method]][['unmix_trans']]) = spec_nms
  }
  return(res)
}
```


# Artificial data pipeline 

## Load and parse spectra from json


```{r spectra}
spctr = fromJSON(file = "panel1_lymph_subtracted_fixed.json")
spectra = matrix(ncol = 64, nrow = length(spctr))
spec_names = c()
for (i in 1:length(spctr)) {
  spectra[i, ] = spctr[[i]]$spectrum$mS
  spec_names = c(spec_names, spctr[[i]]$antigen)
}
colnames(spectra) = spctr[[1]]$spectrum$channels
rm(spctr)
rownames(spectra) = spec_names
nspectra = nrow(spectra)
ndetects = ncol(spectra)
```

## Load and parse phenotype table

Unpack the tree-like structure of the phenotype table using previously defined recursive function. 

```{r pheno_unpack}
pheno = read.csv('phenotypes_noAFonly.csv',
                 sep = ',',
                 fileEncoding = "UTF-8-BOM")
todel = c()
pheno = recur_unpack(c('base'), pheno, todel)
#write.csv(pheno,'pheno_unpacked.csv') #if you are interested in unpacked phenotypes uncomment this
```


# Comparison of unmixing methods

## MSE based comparison

1. Generate data and compute unmixing using Nougad, WOLS and OLS.

```{r NGD_mt}
stronk = c(2, 3, 9, 14, 17, 21)

small = get_data_struct(spectra, pheno, 2000, stronk)
med = get_data_struct(spectra, pheno, 10000, stronk)
big = get_data_struct(spectra, pheno, 100000, stronk)
```

If you want to compare performance with the singlethreaded implementation. THIS CAN TAKE A LONG TIME on a weaker system.

```{r NGD_st}
start.time = Sys.time()
tmp = nougad(
  big$received,
  spectra = spectra,
  snw = 5,
  spw = 1,
  nw = 200,
  start = 2,
  iters = 500,
  alpha = 0.01
)$unmixed
stop.time = Sys.time()
cat('Singlehreaded nougad: ')
stop.time - start.time
start.time = Sys.time()
tmp = nougadmt(
  big$received,
  spectra = spectra,
  snw = 5,
  spw = 1,
  nw = 200,
  start = 2,
  iters = 500,
  alpha = 0.01,
  nthreads = detectCores()
)$unmixed
stop.time = Sys.time()
cat('Multithreaded nougad: ')
stop.time - start.time
rm(tmp)
```

(Speed up from going multithreaded is almost 20x on my Ryzen 9 5900X CPU with 12cores/24threads and 64GB of RAM. For 100000 cells this means going from ~112s to ~5.7s which is significant.)

4. Compare MSE against ground truth

```{r MSE,echo=FALSE}
cat(paste0('MSE for NGD big dataset: ', big$ngd$mse , '\n'))
cat(paste0('MSE for WOLS big dataset: ', big$ols$mse , '\n'))
cat(paste0('MSE for OLS big dataset: ', big$wols$mse , '\n', '\n'))
cat(paste0('MSE for NGD big dataset clamped to 0: ', big$zeroclamp_ngd$mse , '\n'))
cat(paste0('MSE for WOLS big dataset clamped to 0: ', big$zeroclamp_ols$mse , '\n'))
cat(paste0('MSE for OLS big dataset clamped to 0: ', big$zeroclamp_wols$mse , '\n', '\n', '\n'))

cat(paste0('MSE for NGD medium dataset: ', med$ngd$mse , '\n'))
cat(paste0('MSE for WOLS medium dataset: ', med$ols$mse , '\n'))
cat(paste0('MSE for OLS medium dataset: ', med$wols$mse , '\n', '\n'))
cat(paste0('MSE for NGD medium dataset clamped to 0: ', med$zeroclamp_ngd$mse , '\n'))
cat(paste0('MSE for WOLS medium dataset clamped to 0: ', med$zeroclamp_ols$mse , '\n'))
cat(paste0('MSE for OLS medium dataset clamped to 0: ', med$zeroclamp_wols$mse , '\n', '\n', '\n'))

cat(paste0('MSE for NGD small dataset: ', small$ngd$mse , '\n'))
cat(paste0('MSE for WOLS small dataset: ', small$ols$mse , '\n'))
cat(paste0('MSE for OLS small dataset: ', small$wols$mse , '\n', '\n'))
cat(paste0('MSE for NGD small dataset clamped to 0: ', small$zeroclamp_ngd$mse , '\n'))
cat(paste0('MSE for WOLS small dataset clamped to 0: ', small$zeroclamp_ols$mse , '\n'))
cat(paste0('MSE for OLS small dataset clamped to 0: ', small$zeroclamp_wols$mse , '\n'))
```


## Compare error distributions 

1. Compare error distribution shape and magnitude over different methods. 

```{r errdist_overall}
x = 1:(med$n * nspectra)
par(
  mfrow = c(3, 1),
  tcl = 0.5,
  mgp = c(0, -1.4, 0),
  mar = c(0, 0, 1.5, 0)
)
plot(
  x,
  as.matrix(med$ngd$sq_err),
  type = 'l',
  col = 'red',
  pch = 16,
  cex = .1,
  ylim = c(0, 50),
  main = paste0('NGD MSE=', round(med$ngd$mse, 4), ' SD_mse=', round(sd(
    as.matrix(med$ngd$sq_err)
  ), 4)),
  xaxt = 'n'
)
plot(
  x,
  as.matrix(med$wols$sq_err),
  type = 'l',
  col = 'red',
  pch = 16,
  cex = .1,
  ylim = c(0, 50),
  main = paste0('WOLS MSE=', round(med$wols$mse, 4), ' SD_mse=', round(sd(
    as.matrix(med$wols$sq_err)
  ), 4)),
  xaxt = 'n'
)
plot(
  x,
  as.matrix(med$ols$sq_err),
  type = 'l',
  col = 'red',
  pch = 16,
  cex = .1,
  ylim = c(0, 50),
  main = paste0('OLS MSE=', round(med$ols$mse, 4), ' SD_mse=', round(sd(
    as.matrix(med$ols$sq_err)
  ), 4)),
  xaxt = 'n'
)
par(
  mfrow = c(3, 1),
  tcl = 0.5,
  mgp = c(0, -1.4, 0),
  mar = c(0, 0, 1.5, 0)
)
plot(
  x,
  as.matrix(med$zeroclamp_ngd$sq_err),
  type = 'l',
  col = 'red',
  pch = 16,
  cex = .1,
  ylim = c(0, 50),
  main = paste0(
    '0 clamp NGD MSE=',
    round(med$zeroclamp_ngd$mse, 4),
    ' SD_mse=',
    round(sd(as.matrix(
      med$zeroclamp_ngd$sq_err
    )), 4)
  ),
  xaxt = 'n'
)
plot(
  x,
  as.matrix(med$zeroclamp_wols$sq_err),
  type = 'l',
  col = 'red',
  pch = 16,
  cex = .1,
  ylim = c(0, 50),
  main = paste0(
    '0 clamp WOLS MSE=',
    round(med$zeroclamp_wols$mse, 4),
    ' SD_mse=',
    round(sd(as.matrix(
      med$zeroclamp_wols$sq_err
    )), 4)
  ),
  xaxt = 'n'
)
plot(
  x,
  as.matrix(med$zeroclamp_ols$sq_err),
  type = 'l',
  col = 'red',
  pch = 16,
  cex = .1,
  ylim = c(0, 50),
  main = paste0(
    '0 clamp OLS MSE=',
    round(med$zeroclamp_ols$mse, 4),
    ' SD_mse=',
    round(sd(as.matrix(
      med$zeroclamp_ols$sq_err
    )), 4)
  ),
  xaxt = 'n'
)
```

2. Compare error distribution of mean per cell errors over all methods.
(Note the "gap" with near 0 errors in all methods - this where dead cells with ~0 expression in all spectra are.)

```{r errdist_cell}
rnms_small = rownames(small$received)
rnms_small = sapply(strsplit(rnms_small, split = '.', fixed = TRUE), function(x)
  (x[1]))
uq_small = unique(rnms_small)
occurs_small = Vectorize(grep, 'pattern')(paste0('^', uq_small, '$'), rnms_small)
cnts_small = as.vector(sapply(occurs_small, length))
coords_small = c(0)
for (i in 1:length(cnts_small))
{
  coords_small[i + 1] = sum(cnts_small[1:i])
}
coords_small = coords_small[-length(coords_small)]

x = 1:small$n
par(
  mfrow = c(3, 1),
  tcl = 0.5,
  mgp = c(0, -1.4, 0),
  mar = c(0, 0, 1.5, 0)
)
plot(
  x,
  small$ngd$mean_cell_err,
  pch = 16,
  cex = .1,
  ylim = c(0, 15),
  main = 'NGD',
  type = 'l',
  col = 'red',
  xaxt = 'n',
  yaxt = 'n'
)
lines(x, norm(small$cell_brightness) * 15 , col = alpha('green', 0.5))
legend(
  round(small$n - 1 / 7 * small$n),
  15,
  legend = c("Squared error", "Cell luminance"),
  col = c("red", "green"),
  lty = 1:2
)
axis(2,
     at = seq(0, 15, 2),
     labels = T,
     gap.axis = 0)
plot(
  x,
  small$wols$mean_cell_err,
  pch = 16,
  cex = .1,
  ylim = c(0, 15),
  main = 'WOLS',
  type = 'l',
  col = 'red',
  xaxt = 'n',
  xlab = '',
  yaxt = 'n'
)
lines(x, norm(small$cell_brightness) * 15 , col = alpha('green', 0.5))
text(
  coords_small,
  par("usr")[3] + 15,
  srt = 90,
  adj = 1,
  xpd = TRUE,
  labels = uq_small,
  cex = 1
)
axis(1,
     gap.axis = 1,
     padj = 0.5,
     xaxt = 'n')
axis(2,
     at = seq(0, 15, 2),
     labels = T,
     gap.axis = 0)
plot(
  x,
  small$ols$mean_cell_err,
  pch = 16,
  cex = .1,
  ylim = c(0, 15),
  main = 'OLS',
  type = 'l',
  col = 'red',
  xaxt = 'n',
  yaxt = 'n'
)
lines(x, norm(small$cell_brightness) * 15 , col = alpha('green', 0.5))
axis(2,
     at = seq(0, 15, 2),
     labels = T,
     gap.axis = 0)

par(
  mfrow = c(3, 1),
  tcl = 0.5,
  mgp = c(0, -1.4, 0),
  mar = c(0, 0, 1.5, 0)
)
plot(
  x,
  small$zeroclamp_ngd$mean_cell_err,
  pch = 16,
  cex = .1,
  ylim = c(0, 15),
  main = '0 clamp NGD',
  type = 'l',
  col = 'red',
  xaxt = 'n',
  yaxt = 'n'
)
lines(x, norm(small$cell_brightness) * 15 , col = alpha('green', 0.5))
legend(
  round(small$n - 1 / 7 * small$n),
  15,
  legend = c("Squared error", "Cell luminance"),
  col = c("red", "green"),
  lty = 1:2
)
axis(2,
     at = seq(0, 15, 2),
     labels = T,
     gap.axis = 0)
plot(
  x,
  small$zeroclamp_wols$mean_cell_err,
  pch = 16,
  cex = .1,
  ylim = c(0, 15),
  main = '0 clamp WOLS',
  type = 'l',
  col = 'red',
  xaxt = 'n',
  xlab = '',
  yaxt = 'n'
)
lines(x, norm(small$cell_brightness) * 15 , col = alpha('green', 0.5))
text(
  coords_small,
  par("usr")[3] + 15,
  srt = 90,
  adj = 1,
  xpd = TRUE,
  labels = uq_small,
  cex = 1
)
axis(1,
     gap.axis = 1,
     padj = 0.5,
     xaxt = 'n')
axis(2,
     at = seq(0, 15, 2),
     labels = T,
     gap.axis = 0)
plot(
  x,
  small$zeroclamp_ols$mean_cell_err,
  pch = 16,
  cex = .1,
  ylim = c(0, 15),
  main = '0 clamp OLS',
  type = 'l',
  col = 'red',
  xaxt = 'n',
  yaxt = 'n'
)
lines(x, norm(small$cell_brightness) * 15 , col = alpha('green', 0.5))
axis(2,
     at = seq(0, 15, 2),
     labels = T,
     gap.axis = 0)
```

Correlation of mean per cell error with total cell brightness:

```{r errcor_cell}
cn = cor.test(big$cell_brightness, big$ngd$mean_cell_err)
co = cor.test(big$cell_brightness, big$ols$mean_cell_err)
cw = cor.test(big$cell_brightness, big$wols$mean_cell_err)

cnc = cor.test(big$cell_brightness, big$zeroclamp_ngd$mean_cell_err)
coc = cor.test(big$cell_brightness, big$zeroclamp_ols$mean_cell_err)
cwc = cor.test(big$cell_brightness, big$zeroclamp_wols$mean_cell_err)

par(mar = c(0, 0, 3, 0), mfrow = c(1, 3))
plot(
  norm(big$cell_brightness),
  norm(big$ngd$mean_cell_err),
  pch = 16,
  cex = .1,
  main = paste0(
    'NGD r=',
    round(cn$estimate, 3),
    ' 95CI=(',
    round(cn$conf.int[1], 2),
    ';',
    round(cn$conf.int[2], 2),
    ')\n p',
    format.pval(cn$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')
plot(
  norm(big$cell_brightness),
  norm(big$wols$mean_cell_err),
  pch = 16,
  cex = .1,
  main = paste0(
    'WOLS r=',
    round(cw$estimate, 3),
    ' 95CI=(',
    round(cw$conf.int[1], 2),
    ';',
    round(cw$conf.int[2], 2),
    ')\n p',
    format.pval(cw$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')
plot(
  norm(big$cell_brightness),
  norm(big$ols$mean_cell_err),
  pch = 16,
  cex = .1,
  main = paste0(
    'OLS r=',
    round(co$estimate, 3),
    ' 95CI=(',
    round(co$conf.int[1], 2),
    ';',
    round(co$conf.int[2], 2),
    ')\n p',
    format.pval(co$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')

par(mar = c(0, 0, 3, 0), mfrow = c(1, 3))
plot(
  norm(big$cell_brightness),
  norm(big$zeroclamp_ngd$mean_cell_err),
  pch = 16,
  cex = .1,
  main = paste0(
    '0 clamp NGD r=',
    round(cnc$estimate, 3),
    '\n95CI=(',
    round(cnc$conf.int[1], 2),
    ';',
    round(cnc$conf.int[2], 2),
    ') p',
    format.pval(cnc$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')
plot(
  norm(big$cell_brightness),
  norm(big$zeroclamp_wols$mean_cell_err),
  pch = 16,
  cex = .1,
  main = paste0(
    '0 clamp WOLS r=',
    round(cwc$estimate, 3),
    '\n95CI=(',
    round(cwc$conf.int[1], 2),
    ';',
    round(cwc$conf.int[2], 2),
    ') p',
    format.pval(cwc$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')
plot(
  norm(big$cell_brightness),
  norm(big$zeroclamp_ols$mean_cell_err),
  pch = 16,
  cex = .1,
  main = paste0(
    '0 clamp OLS r=',
    round(coc$estimate, 3),
    '\n95CI=(',
    round(coc$conf.int[1], 2),
    ';',
    round(coc$conf.int[2], 2),
    ') p',
    format.pval(coc$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')
```

3. Compare error distribution over different spectra for different methods
This should serve to look at which spectra are more prone to errors and how/if the error distribution for each spectrum changes depending on the selected method.
Note that counts (Y axis) are log scaled.

For unclamped methods.

```{r errdist_spec}
spec_int = norm(rowSums(spectra) ^ 2) #Total energy of the given spectrum
mean_ag_expr = norm(colSums(big$gt_trans) / nspectra)#Mean expression of that spectrum in the data (ground truth)
colvec <- colorRampPalette(c("green", "yellow", "red"))
cvc = c(colvec(10), rep('red', 10))
for (i in 1:nspectra) {
  par(mar = c(0, 2, 2, 0), mfrow = c(1, 3))
  ols_vec = big$ols$sq_err[, i]
  wols_vec = big$wols$sq_err[, i]
  ngd_vec = big$ngd$sq_err[, i]
  xmx = max(c(max(ols_vec), max(wols_vec), max(ngd_vec)))
  h_ols =
    hist(ols_vec,
         plot = FALSE,
         breaks = seq(0, xmx, length.out = 20))
  h_ols$counts = log(h_ols$counts)
  h_ols$counts[h_ols$counts == -Inf] = 0
  h_wols =
    hist(wols_vec,
         plot = FALSE,
         breaks = seq(0, xmx, length.out = 20))
  h_wols$counts = log(h_wols$counts)
  h_wols$counts[h_wols$counts == -Inf] = 0
  h_ngd =
    hist(ngd_vec,
         plot = FALSE,
         breaks = seq(0, xmx, length.out = 20))
  h_ngd$counts = log(h_ngd$counts)
  h_ngd$counts[h_ngd$counts == -Inf] = 0
  ymx = max(c(max(h_ols$counts), max(h_wols$counts), max(h_ngd$counts)))
  plot(
    h_ngd,
    col = cvc,
    main = paste0(
      spec_names[i],
      ' NGD\n E=',
      round(spec_int[i], 3),
      ' M(Ex)=',
      round(mean_ag_expr[i], 3)
    ),
    xaxt = 'n',
    xlim = c(0, xmx),
    ylim = c(0, ymx)
  )
  plot(
    h_wols,
    col = cvc,
    main = paste0(
      spec_names[i],
      ' WOLS\n E=',
      round(spec_int[i], 3),
      ' M(Ex)=',
      round(mean_ag_expr[i], 3)
    ),
    xaxt = 'n',
    xlim = c(0, xmx),
    ylim = c(0, ymx),
    yaxt = 'n'
  )
  plot(
    h_ols,
    col = cvc,
    main = paste0(
      spec_names[i],
      ' OLS\n E=',
      round(spec_int[i], 3),
      ' M(Ex)r=',
      round(mean_ag_expr[i], 3)
    ),
    xaxt = 'n',
    xlim = c(0, xmx),
    ylim = c(0, ymx),
    yaxt = 'n'
  )
}
```

Clamped to 0.

```{r errdist_spec_clp}
for (i in 1:nspectra) {
  par(mar = c(0, 2, 2, 0), mfrow = c(1, 3))
  ols_vec = big$zeroclamp_ols$sq_err[, i]
  wols_vec = big$zeroclamp_wols$sq_err[, i]
  ngd_vec = big$zeroclamp_ngd$sq_err[, i]
  xmx = max(c(max(ols_vec), max(wols_vec), max(ngd_vec)))
  h_ols =
    hist(ols_vec,
         plot = FALSE,
         breaks = seq(0, xmx, length.out = 20))
  h_ols$counts = log(h_ols$counts)
  h_ols$counts[h_ols$counts == -Inf] = 0
  h_wols =
    hist(wols_vec,
         plot = FALSE,
         breaks = seq(0, xmx, length.out = 20))
  h_wols$counts = log(h_wols$counts)
  h_wols$counts[h_wols$counts == -Inf] = 0
  h_ngd =
    hist(ngd_vec,
         plot = FALSE,
         breaks = seq(0, xmx, length.out = 20))
  h_ngd$counts = log(h_ngd$counts)
  h_ngd$counts[h_ngd$counts == -Inf] = 0
  ymx = max(c(max(h_ols$counts), max(h_wols$counts), max(h_ngd$counts)))
  plot(
    h_ngd,
    col = cvc,
    main = paste0(
      spec_names[i],
      ' 0 clamp NGD\n E=',
      round(spec_int[i], 3),
      ' M(Ex)=',
      round(mean_ag_expr[i], 3)
    ),
    xaxt = 'n',
    xlim = c(0, xmx),
    ylim = c(0, ymx)
  )
  plot(
    h_wols,
    col = cvc,
    main = paste0(
      spec_names[i],
      ' 0 clamp WOLS\n E=',
      round(spec_int[i], 3),
      ' M(Ex)=',
      round(mean_ag_expr[i], 3)
    ),
    xaxt = 'n',
    xlim = c(0, xmx),
    ylim = c(0, ymx),
    yaxt = 'n'
  )
  plot(
    h_ols,
    col = cvc,
    main = paste0(
      spec_names[i],
      ' 0 clamp OLS\n E=',
      round(spec_int[i], 3),
      ' M(Ex)r=',
      round(mean_ag_expr[i], 3)
    ),
    xaxt = 'n',
    xlim = c(0, xmx),
    ylim = c(0, ymx),
    yaxt = 'n'
  )
  
}
```

Correlation of mean spectrum error with the spectrum energy.

```{r errcor_spec}
cn = cor.test(big$ngd$mean_spec_err, spec_int)
co = cor.test(big$ols$mean_spec_err, spec_int)
cw = cor.test(big$wols$mean_spec_err, spec_int)

cnc = cor.test(big$zeroclamp_ngd$mean_spec_err, spec_int)
coc = cor.test(big$zeroclamp_ols$mean_spec_err, spec_int)
cwc = cor.test(big$zeroclamp_wols$mean_spec_err, spec_int)

par(mar = c(0, 0, 3, 0), mfrow = c(1, 3))
plot(
  norm(spec_int),
  norm(big$ngd$mean_spec_err),
  pch = 16,
  cex = .1,
  main = paste0(
    'NGD r=',
    round(cn$estimate, 3),
    ' 95CI=(',
    round(cn$conf.int[1], 2),
    ';',
    round(cn$conf.int[2], 2),
    ')\n p=',
    format.pval(cn$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')
plot(
  norm(spec_int),
  norm(big$wols$mean_spec_err),
  pch = 16,
  cex = .1,
  main = paste0(
    'WOLS r=',
    round(cw$estimate, 3),
    ' 95CI=(',
    round(cw$conf.int[1], 2),
    ';',
    round(cw$conf.int[2], 2),
    ')\n p=',
    format.pval(cw$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')
plot(
  norm(spec_int),
  norm(big$ols$mean_spec_err),
  pch = 16,
  cex = .1,
  main = paste0(
    'OLS r=',
    round(co$estimate, 3),
    ' 95CI=(',
    round(co$conf.int[1], 2),
    ';',
    round(co$conf.int[2], 2),
    ')\n p=',
    format.pval(co$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')

par(mar = c(0, 0, 3, 0), mfrow = c(1, 3))
plot(
  norm(spec_int),
  norm(big$zeroclamp_ngd$mean_spec_err),
  pch = 16,
  cex = .1,
  main = paste0(
    '0 clamp NGD r=',
    round(cnc$estimate, 3),
    ' \n95CI=(',
    round(cnc$conf.int[1], 2),
    ';',
    round(cnc$conf.int[2], 2),
    ') p=',
    format.pval(cnc$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')
plot(
  norm(spec_int),
  norm(big$zeroclamp_wols$mean_spec_err),
  pch = 16,
  cex = .1,
  main = paste0(
    '0 clamp WOLS r=',
    round(cwc$estimate, 3),
    ' \n95CI=(',
    round(cwc$conf.int[1], 2),
    ';',
    round(cwc$conf.int[2], 2),
    ') p=',
    format.pval(cwc$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')
plot(
  norm(spec_int),
  norm(big$zeroclamp_ols$mean_spec_err),
  pch = 16,
  cex = .1,
  main = paste0(
    '0 clamp OLS r=',
    round(coc$estimate, 3),
    ' \n95CI=(',
    round(coc$conf.int[1], 2),
    ';',
    round(coc$conf.int[2], 2),
    ') p=',
    format.pval(coc$p.value)
  ),
  xaxt = 'n',
  yaxt = 'n'
)
abline(0, 1, col = 'red')
```

## Visually compare unmixed cells to ground truth in 2D space

1. Compare selected marker pairs on 2D plots

Using lines.

```{r lines_pairs}
marker_cords = which(mean_ag_expr > 0.3)
markers = spec_names[marker_cords]
markers = markers[markers != 'Autofluorescence']
combos = combn(markers, 2)
for (i in 1:ncol(combos)) {
  p1 = ggplot()  + geom_segment(
    aes(
      x = small$gt_trans[combos[1, i]][, 1],
      y = small$gt_trans[combos[2, i]][, 1],
      xend = small$ngd$unmix_trans[combos[1, i]][, 1],
      yend = small$ngd$unmix_trans[combos[2, i]][, 1]
    ),
    colour = "red",
    alpha = 0.5
  ) + geom_point(aes(x = small$gt_trans[combos[1, i]][, 1], y = small$gt_trans[combos[2, i]][, 1]),
                 size = 0.5,
                 alpha = 0.3) + theme_cowplot() + ylab(combos[2, i]) + xlab('') + ggtitle('NGD')
  p2 = ggplot()  + geom_segment(
    aes(
      x = small$gt_trans[combos[1, i]][, 1],
      y = small$gt_trans[combos[2, i]][, 1],
      xend = small$wols$unmix_trans[combos[1, i]][, 1],
      yend = small$wols$unmix_trans[combos[2, i]][, 1]
    ),
    colour = "red",
    alpha = 0.5
  ) + geom_point(aes(x = small$gt_trans[combos[1, i]][, 1], y = small$gt_trans[combos[2, i]][, 1]),
                 size = 0.5,
                 alpha = 0.3) + theme_cowplot() + ylab('') + xlab(combos[1, i]) + ggtitle('WOLS')
  p3 = ggplot()  + geom_segment(
    aes(
      x = small$gt_trans[combos[1, i]][, 1],
      y = small$gt_trans[combos[2, i]][, 1],
      xend = small$ols$unmix_trans[combos[1, i]][, 1],
      yend = small$ols$unmix_trans[combos[2, i]][, 1]
    ),
    colour = "red",
    alpha = 0.5
  ) + geom_point(aes(x = small$gt_trans[combos[1, i]][, 1], y = small$gt_trans[combos[2, i]][, 1]),
                 size = 0.5,
                 alpha = 0.3) + theme_cowplot() + ylab('') + xlab('') + ggtitle('OLS')
  
  print(ggarrange(p1, p2, p3, ncol = 3))
  
}
```

Clamped to 0.

```{r lines_pairs_clp}
ngd_t_1k = as.data.frame(small$zeroclamp_ngd$unmix_trans)
ols_t_1k = as.data.frame(small$zeroclamp_ols$unmix_trans)
wols_t_1k = as.data.frame(small$zeroclamp_wols$unmix_trans)

for (i in 1:ncol(combos)) {
  p1 = ggplot()  + geom_segment(
    aes(
      x = small$gt_trans[combos[1, i]][, 1],
      y = small$gt_trans[combos[2, i]][, 1],
      xend = small$zeroclamp_ngd$unmix_trans[combos[1, i]][, 1],
      yend = small$zeroclamp_ngd$unmix_trans[combos[2, i]][, 1]
    ),
    colour = "red",
    alpha = 0.5
  ) + geom_point(aes(x = small$gt_trans[combos[1, i]][, 1], y = small$gt_trans[combos[2, i]][, 1]),
                 size = 0.5,
                 alpha = 0.3) + theme_cowplot() + ylab(combos[2, i]) + xlab('') + ggtitle('0 clamp NGD')
  p2 = ggplot()  + geom_segment(
    aes(
      x = small$gt_trans[combos[1, i]][, 1],
      y = small$gt_trans[combos[2, i]][, 1],
      xend = small$zeroclamp_wols$unmix_trans[combos[1, i]][, 1],
      yend = small$zeroclamp_wols$unmix_trans[combos[2, i]][, 1]
    ),
    colour = "red",
    alpha = 0.5
  ) + geom_point(aes(x = small$gt_trans[combos[1, i]][, 1], y = small$gt_trans[combos[2, i]][, 1]),
                 size = 0.5,
                 alpha = 0.3) + theme_cowplot() + ylab('') + xlab(combos[1, i]) + ggtitle('0 clamp WOLS')
  p3 = ggplot()  + geom_segment(
    aes(
      x = small$gt_trans[combos[1, i]][, 1],
      y = small$gt_trans[combos[2, i]][, 1],
      xend = small$zeroclamp_ols$unmix_trans[combos[1, i]][, 1],
      yend = small$zeroclamp_ols$unmix_trans[combos[2, i]][, 1]
    ),
    colour = "red",
    alpha = 0.5
  ) + geom_point(aes(x = small$gt_trans[combos[1, i]][, 1], y = small$gt_trans[combos[2, i]][, 1]),
                 size = 0.5,
                 alpha = 0.3) + theme_cowplot() + ylab('') + xlab('') + ggtitle('0 clamp OLS')
  
  print(ggarrange(p1, p2, p3, ncol = 3))
  
}
```

Color cells by squared error magnitude.

```{r errcolor_pairs} 
for (i in 1:ncol(combos)) {
  aes_engd = rowSums(med$ngd$sq_err[, c(combos[1, i], combos[2, i])]) / 2
  aes_eols = rowSums(med$ols$sq_err[, c(combos[1, i], combos[2, i])]) / 2
  aes_ewols = rowSums(med$wols$sq_err[, c(combos[1, i], combos[2, i])]) / 2
  mx = max(c(max(aes_engd), max(aes_eols), max(aes_ewols)))
  x_gt = med$gt_trans[combos[1, i]][, 1]
  y_gt = med$gt_trans[combos[2, i]][, 1]
  x_ngd = med$ngd$unmix_trans[combos[1, i]][, 1]
  y_ngd = med$ngd$unmix_trans[combos[2, i]][, 1]
  x_ols = med$ols$unmix_trans[combos[1, i]][, 1]
  y_ols = med$ols$unmix_trans[combos[2, i]][, 1]
  x_wols = med$wols$unmix_trans[combos[1, i]][, 1]
  y_wols = med$wols$unmix_trans[combos[2, i]][, 1]
  mx_x = max(c(max(x_ols), max(x_wols), max(x_ngd), max(x_gt)))
  mx_y = max(c(max(y_ols), max(y_wols), max(y_ngd), max(y_gt)))
  mn_x = min(c(min(x_ols), min(x_wols), min(x_ngd), min(x_gt)))
  mn_y = min(c(min(y_ols), min(y_wols), min(y_ngd), min(y_gt)))
  Error = rep(0, med$n)
  
  p1 = qplot() + geom_point(aes(x_gt, y_gt, colour = Error),
                            size = 1,
                            alpha = 0.5) + scale_colour_gradientn(
                              limits = c(0, mx),
                              trans = 'pseudo_log',
                              colours = c("blue", "yellow", "red"),
                              labels = c(' 0', ' 2', ' 5', '10 ', '20 ', '40 ', '60 '),
                              breaks = c(0, 2, 5, 10, 20, 40, 60)
                            ) + ggtitle('Ground Truth') + theme_cowplot() +
    ylab('') + xlab('') + scale_x_continuous(limits = c(mn_x, mx_x)) + scale_y_continuous(limits = c(mn_y, mx_y)) +
    theme_void()
  p2 = qplot() + geom_point(aes(x_ngd, y_ngd, colour = aes_engd),
                            size = 1,
                            alpha = 0.5) + scale_colour_gradientn(
                              limits = c(0, mx),
                              trans = 'pseudo_log',
                              colours = c("blue", "yellow", "red"),
                              labels = c(' 0', ' 2', ' 5', '10 ', '20 ', '40 ', '60 '),
                              breaks = c(0, 2, 5, 10, 20, 40, 60)
                            ) + ggtitle('NGD') + theme_cowplot() +
    ylab('') + xlab('') + scale_x_continuous(limits = c(mn_x, mx_x)) + scale_y_continuous(limits = c(mn_y, mx_y)) +
    theme_void()
  p3 = qplot() + geom_point(aes(x_wols, y_wols, colour = aes_ewols),
                            size = 1,
                            alpha = 0.5) + scale_colour_gradientn(
                              limits = c(0, mx),
                              trans = 'pseudo_log',
                              colours = c("blue", "yellow", "red"),
                              labels = c(' 0', ' 2', ' 5', '10 ', '20 ', '40 ', '60 '),
                              breaks = c(0, 2, 5, 10, 20, 40, 60)
                            ) + ggtitle('WOLS') + theme_cowplot() +
    ylab(combos[2, i]) + xlab(combos[1, i]) + scale_x_continuous(limits = c(mn_x, mx_x)) +
    scale_y_continuous(limits = c(mn_y, mx_y)) + theme_void()
  p4 = qplot() + geom_point(aes(x_ols, y_ols, colour = aes_eols),
                            size = 1,
                            alpha = 0.5) + scale_colour_gradientn(
                              limits = c(0, mx),
                              trans = 'pseudo_log',
                              colours = c("blue", "yellow", "red"),
                              labels = c(' 0', ' 2', ' 5', '10 ', '20 ', '40 ', '60 '),
                              breaks = c(0, 2, 5, 10, 20, 40, 60)
                            ) + ggtitle('OLS') + theme_cowplot() +
    ylab('') + xlab('') + scale_x_continuous(limits = c(mn_x, mx_x)) + scale_y_continuous(limits = c(mn_y, mx_y)) +
    theme_void()
  figure = ggarrange(
    p1,
    p2,
    p3,
    p4,
    ncol = 2,
    nrow = 2,
    common.legend = T,
    legend = 'right'
  ) + theme(plot.background = element_rect())
  print(annotate_figure(
    figure,
    left = text_grob(combos[2, i], rot = 90),
    bottom = text_grob(paste0(combos[1, i], '\n', '\n'))
  ))
}
```

Clamped to 0.

```{r errcolor_pairs_clamp} 
for (i in 1:ncol(combos)) {
  aes_engd = rowSums(med$zeroclamp_ngd$sq_err[, c(combos[1, i], combos[2, i])]) / 2
  aes_eols = rowSums(med$zeroclamp_ols$sq_err[, c(combos[1, i], combos[2, i])]) / 2
  aes_ewols = rowSums(med$zeroclamp_wols$sq_err[, c(combos[1, i], combos[2, i])]) / 2
  mx = max(c(max(aes_engd), max(aes_eols), max(aes_ewols)))
  x_gt = med$gt_trans[combos[1, i]][, 1]
  y_gt = med$gt_trans[combos[2, i]][, 1]
  x_ngd = med$zeroclamp_ngd$unmix_trans[combos[1, i]][, 1]
  y_ngd = med$zeroclamp_ngd$unmix_trans[combos[2, i]][, 1]
  x_ols = med$zeroclamp_ols$unmix_trans[combos[1, i]][, 1]
  y_ols = med$zeroclamp_ols$unmix_trans[combos[2, i]][, 1]
  x_wols = med$zeroclamp_wols$unmix_trans[combos[1, i]][, 1]
  y_wols = med$zeroclamp_wols$unmix_trans[combos[2, i]][, 1]
  mx_x = max(c(max(x_ols), max(x_wols), max(x_ngd), max(x_gt)))
  mx_y = max(c(max(y_ols), max(y_wols), max(y_ngd), max(y_gt)))
  mn_x = min(c(min(x_ols), min(x_wols), min(x_ngd), min(x_gt)))
  mn_y = min(c(min(y_ols), min(y_wols), min(y_ngd), min(y_gt)))
  Error = rep(0, med$n)
  
  p1 = qplot() + geom_point(aes(x_gt, y_gt, colour = Error),
                            size = 1,
                            alpha = 0.5) + scale_colour_gradientn(
                              limits = c(0, mx),
                              trans = 'pseudo_log',
                              colours = c("blue", "yellow", "red"),
                              labels = c(' 0', ' 2', ' 5', '10 ', '20 ', '40 ', '60 '),
                              breaks = c(0, 2, 5, 10, 20, 40, 60)
                            ) + ggtitle('Ground Truth') + theme_cowplot() +
    ylab('') + xlab('') + scale_x_continuous(limits = c(mn_x, mx_x)) + scale_y_continuous(limits = c(mn_y, mx_y)) +
    theme_void()
  p2 = qplot() + geom_point(aes(x_ngd, y_ngd, colour = aes_engd),
                            size = 1,
                            alpha = 0.5) + scale_colour_gradientn(
                              limits = c(0, mx),
                              trans = 'pseudo_log',
                              colours = c("blue", "yellow", "red"),
                              labels = c(' 0', ' 2', ' 5', '10 ', '20 ', '40 ', '60 '),
                              breaks = c(0, 2, 5, 10, 20, 40, 60)
                            ) + ggtitle('0 clamp NGD') + theme_cowplot() +
    ylab('') + xlab('') + scale_x_continuous(limits = c(mn_x, mx_x)) + scale_y_continuous(limits = c(mn_y, mx_y)) +
    theme_void()
  p3 = qplot() + geom_point(aes(x_wols, y_wols, colour = aes_ewols),
                            size = 1,
                            alpha = 0.5) + scale_colour_gradientn(
                              limits = c(0, mx),
                              trans = 'pseudo_log',
                              colours = c("blue", "yellow", "red"),
                              labels = c(' 0', ' 2', ' 5', '10 ', '20 ', '40 ', '60 '),
                              breaks = c(0, 2, 5, 10, 20, 40, 60)
                            ) + ggtitle('0 clamp WOLS') + theme_cowplot() +
    ylab(combos[2, i]) + xlab(combos[1, i]) + scale_x_continuous(limits = c(mn_x, mx_x)) +
    scale_y_continuous(limits = c(mn_y, mx_y)) + theme_void()
  p4 = qplot() + geom_point(aes(x_ols, y_ols, colour = aes_eols),
                            size = 1,
                            alpha = 0.5) + scale_colour_gradientn(
                              limits = c(0, mx),
                              trans = 'pseudo_log',
                              colours = c("blue", "yellow", "red"),
                              labels = c(' 0', ' 2', ' 5', '10 ', '20 ', '40 ', '60 '),
                              breaks = c(0, 2, 5, 10, 20, 40, 60)
                            ) + ggtitle('0 clamp OLS') + theme_cowplot() +
    ylab('') + xlab('') + scale_x_continuous(limits = c(mn_x, mx_x)) + scale_y_continuous(limits = c(mn_y, mx_y)) +
    theme_void()
  figure = ggarrange(
    p1,
    p2,
    p3,
    p4,
    ncol = 2,
    nrow = 2,
    common.legend = T,
    legend = 'right'
  ) + theme(plot.background = element_rect())
  print(annotate_figure(
    figure,
    left = text_grob(combos[2, i], rot = 90),
    bottom = text_grob(paste0(combos[1, i], '\n', '\n'))
  ))
}
```

2. Compare points across all markers embedded and visualized in 2D using self-organizing map from EmbedSOM library

Using lines.

```{r lines_esom}
map = SOM(small$gt_trans, xdim = 20, ydim = 20)
e_gt = EmbedSOM(small$gt_trans, map)
e_ngd = EmbedSOM(small$ngd$unmix_trans, map)
e_ols = EmbedSOM(small$ols$unmix_trans, map)
e_wols = EmbedSOM(small$wols$unmix_trans, map)
p1 = ggplot()  + geom_segment(
  aes(
    x = e_gt[, 1],
    y = e_gt[, 2],
    xend = e_ngd[, 1],
    yend = e_ngd[, 2]
  ),
  colour = "red",
  alpha = 0.3
) + geom_point(aes(x = e_gt[, 1], y = e_gt[, 2]), size = 0.4, alpha = 0.3) +
  ggtitle('NGD') + scale_x_discrete(labels = NULL, breaks = NULL) + labs(x = '', y =
                                                                           '') + scale_y_discrete(labels = NULL, breaks = NULL) + theme_void()
p2 = ggplot()  + geom_segment(
  aes(
    x = e_gt[, 1],
    y = e_gt[, 2],
    xend = e_wols[, 1],
    yend = e_wols[, 2]
  ),
  colour = "red",
  alpha = 0.3
) + geom_point(aes(x = e_gt[, 1], y = e_gt[, 2]), size = 0.5, alpha = 0.4) +
  ggtitle('WOLS') + scale_x_discrete(labels = NULL, breaks = NULL) + labs(x = '', y =
                                                                            '') + scale_y_discrete(labels = NULL, breaks = NULL) + theme_void()
p3 = ggplot()  + geom_segment(aes(
  e_gt[, 1],
  y = e_gt[, 2],
  xend = e_ols[, 1],
  yend = e_ols[, 2]
),
colour = "red",
alpha = 0.3) + geom_point(aes(x = e_gt[, 1], y = e_gt[, 2]), size = 0.5, alpha =
                            0.4) + ggtitle('OLS') + scale_x_discrete(labels = NULL, breaks = NULL) + labs(x = '', y =
                                                                                                            '') + scale_y_discrete(labels = NULL, breaks = NULL) + theme_void()

p1
p2
p3
ggarrange(p1, p2, p3, ncol = 3)
```

Clamped to 0.

```{r lines_esom_clamp}
map = SOM(small$gt_trans, xdim = 20, ydim = 20)
e_gt = EmbedSOM(small$gt_trans, map)
e_ngd = EmbedSOM(small$zeroclamp_ngd$unmix_trans, map)
e_ols = EmbedSOM(small$zeroclamp_ols$unmix_trans, map)
e_wols = EmbedSOM(small$zeroclamp_wols$unmix_trans, map)
p1 = ggplot()  + geom_segment(
  aes(
    x = e_gt[, 1],
    y = e_gt[, 2],
    xend = e_ngd[, 1],
    yend = e_ngd[, 2]
  ),
  colour = "red",
  alpha = 0.3
) + geom_point(aes(x = e_gt[, 1], y = e_gt[, 2]), size = 0.4, alpha = 0.3) +
  ggtitle('0 clamp NGD') + scale_x_discrete(labels = NULL, breaks = NULL) + labs(x = '', y =
                                                                                     '') + scale_y_discrete(labels = NULL, breaks = NULL) + theme_void()
p2 = ggplot()  + geom_segment(
  aes(
    x = e_gt[, 1],
    y = e_gt[, 2],
    xend = e_wols[, 1],
    yend = e_wols[, 2]
  ),
  colour = "red",
  alpha = 0.3
) + geom_point(aes(x = e_gt[, 1], y = e_gt[, 2]), size = 0.5, alpha = 0.4) +
  ggtitle('0 clamp WOLS') + scale_x_discrete(labels = NULL, breaks = NULL) + labs(x = '', y =
                                                                                      '') + scale_y_discrete(labels = NULL, breaks = NULL) + theme_void()
p3 = ggplot()  + geom_segment(aes(
  e_gt[, 1],
  y = e_gt[, 2],
  xend = e_ols[, 1],
  yend = e_ols[, 2]
),
colour = "red",
alpha = 0.3) + geom_point(aes(x = e_gt[, 1], y = e_gt[, 2]), size = 0.5, alpha =
                            0.4) + ggtitle('0 clamp OLS') + scale_x_discrete(labels = NULL, breaks = NULL) + labs(x = '', y =
                                                                                                                      '') + scale_y_discrete(labels = NULL, breaks = NULL) + theme_void()

p1
p2
p3
ggarrange(p1, p2, p3, ncol = 3)
```

Color SOM by cell type.

```{r ctypes_esom}
map = EmbedSOM::RandomMap(big$gt_trans, 1000, coords = EmbedSOM::UMAPCoords())
e_gt = EmbedSOM(big$gt_trans, map, parallel = T)
e_ngd = EmbedSOM(big$ngd$unmix_trans, map, parallel = T)
e_ols = EmbedSOM(big$ols$unmix_trans, map, parallel = T)
e_wols = EmbedSOM(big$wols$unmix_trans, map, parallel = T)

rnms = sapply(strsplit(rownames(big$received), split = '.', fixed = TRUE), function(x)
  (x[1]))
uq = unique(rnms)
dead_subtypes = uq[grepl('dead', uq, fixed = T)]
rnms[rnms %in% dead_subtypes] = 'dead'
uq = unique(rnms)
distinct11 = c(
  '#a6cee3',
  '#1f78b4',
  '#b2df8a',
  '#33a02c',
  '#fb9a99',
  '#e31a1c',
  '#ff7f00',
  '#cab2d6',
  '#6a3d9a',
  '#ffff99',
  'black'
)
qplot() + geom_point(aes(e_gt[, 1], e_gt[, 2], colour = rnms),
                     size = 0.2,
                     alpha = 0.5)  + ggtitle('Ground Truth') + theme_cowplot() +
  ylab('') + xlab('') + theme_void() + scale_color_manual(breaks = uq, values = distinct11) +
  guides(color = guide_legend(
    ncol = 2,
    title = "Cell type",
    override.aes = list(size = 5)
  ))
```

Color points by per-cell mean squared error.

```{r errcolor_esom}
e_ngd = EmbedSOM(big$ngd$unmix_trans, map, parallel = T)
e_ols = EmbedSOM(big$ols$unmix_trans, map, parallel = T)
e_wols = EmbedSOM(big$wols$unmix_trans, map, parallel = T)
mx = max(c(
  big$ngd$mean_cell_err,
  big$wols$mean_cell_err,
  big$ols$mean_cell_err
))
Error = rep(0, big$n)
p1 = qplot() + geom_point(aes(e_gt[, 1], e_gt[, 2], colour = Error),
                          size = 0.4,
                          alpha = 0.5) + scale_colour_gradientn(
                            limits = c(0, mx),
                            trans = 'pseudo_log',
                            colours = c("blue", "yellow", "red"),
                            labels = c(' 0', ' 2', ' 5', '10 ', '20 '),
                            breaks = c(0, 2, 5, 10, 20)
                          ) + ggtitle('Ground Truth') + theme_cowplot() +
  ylab('') + xlab('') + theme_void()
p2 = qplot() + geom_point(
  aes(e_ngd[, 1], e_ngd[, 2], colour = big$ngd$mean_cell_err),
  size = 0.4,
  alpha = 0.5
) + scale_colour_gradientn(
  limits = c(0, mx),
  trans = 'pseudo_log',
  colours = c("blue", "yellow", "red"),
  labels = c(' 0', ' 2', ' 5', '10 ', '20 '),
  breaks = c(0, 2, 5, 10, 20)
) + ggtitle('NGD') + theme_cowplot() +
  ylab('') + xlab('') + theme_void()
p3 = qplot() + geom_point(
  aes(e_wols[, 1], e_wols[, 2], colour = big$wols$mean_cell_err),
  size = 0.4,
  alpha = 0.5
) + scale_colour_gradientn(
  limits = c(0, mx),
  trans = 'pseudo_log',
  colours = c("blue", "yellow", "red"),
  labels = c(' 0', ' 2', ' 5', '10 ', '20 '),
  breaks = c(0, 2, 5, 10, 20)
) + ggtitle('WOLS') + theme_cowplot() +
  ylab('') + xlab('') + theme_void()
p4 = qplot() + geom_point(
  aes(e_ols[, 1], e_ols[, 2], colour = big$ols$mean_cell_err),
  size = 0.4,
  alpha = 0.5
) + scale_colour_gradientn(
  limits = c(0, mx),
  trans = 'pseudo_log',
  colours = c("blue", "yellow", "red"),
  labels = c(' 0', ' 2', ' 5', '10 ', '20 '),
  breaks = c(0, 2, 5, 10, 20)
) + ggtitle('OLS') + theme_cowplot() +
  ylab('') + xlab('') + theme_void()
ggarrange(
  p1,
  p2,
  p3,
  p4,
  ncol = 2,
  nrow = 2,
  common.legend = T,
  legend = 'right'
)
```

clamped to 0.

```{r errcolor_esom_clamp}
e_ngd_c = EmbedSOM(big$zeroclamp_ngd$unmix_trans, map, parallel = T)
e_ols_c = EmbedSOM(big$zeroclamp_ols$unmix_trans, map, parallel = T)
e_wols_c = EmbedSOM(big$zeroclamp_wols$unmix_trans, map, parallel = T)
mx_c = max(
  c(
    big$zeroclamp_ngd$mean_cell_err,
    big$zeroclamp_wols$mean_cell_err,
    big$zeroclamp_ols$mean_cell_err
  )
)
p1 = qplot() + geom_point(aes(e_gt[, 1], e_gt[, 2], colour = Error),
                          size = 0.4,
                          alpha = 0.5) + scale_colour_gradientn(
                            limits = c(0, mx),
                            trans = 'pseudo_log',
                            colours = c("blue", "yellow", "red"),
                            labels = c(' 0', '1', ' 2', ' 5', '10 ', '20 '),
                            breaks = c(0, 1, 2, 5, 10, 20)
                          ) + ggtitle('Ground Truth') + theme_cowplot() +
  ylab('') + xlab('') + theme_void()
p2 = qplot() + geom_point(
  aes(e_ngd_c[, 1], e_ngd_c[, 2], colour = big$zeroclamp_ngd$mean_cell_err),
  size = 0.4,
  alpha = 0.5
) + scale_colour_gradientn(
  limits = c(0, mx),
  trans = 'pseudo_log',
  colours = c("blue", "yellow", "red"),
  labels = c(' 0', ' 2', ' 5', '10 ', '20 '),
  breaks = c(0, 2, 5, 10, 20)
) + ggtitle('0 clamp NGD') + theme_cowplot() +
  ylab('') + xlab('') + theme_void()
p3 = qplot() + geom_point(
  aes(e_wols_c[, 1], e_wols_c[, 2], colour = big$zeroclamp_wols$mean_cell_err),
  size = 0.4,
  alpha = 0.5
) + scale_colour_gradientn(
  limits = c(0, mx),
  trans = 'pseudo_log',
  colours = c("blue", "yellow", "red"),
  labels = c(' 0', ' 2', ' 5', '10 ', '20 '),
  breaks = c(0, 2, 5, 10, 20)
) + ggtitle('0 clamp WOLS') + theme_cowplot() +
  ylab('') + xlab('') + theme_void()
p4 = qplot() + geom_point(
  aes(e_ols_c[, 1], e_ols_c[, 2], colour = big$zeroclamp_ols$mean_cell_err),
  size = 0.4,
  alpha = 0.5
) + scale_colour_gradientn(
  limits = c(0, mx),
  trans = 'pseudo_log',
  colours = c("blue", "yellow", "red"),
  labels = c(' 0', ' 2', ' 5', '10 ', '20 '),
  breaks = c(0, 2, 5, 10, 20)
) + ggtitle('0 clamp OLS') + theme_cowplot() +
  ylab('') + xlab('') + theme_void()
ggarrange(
  p1,
  p2,
  p3,
  p4,
  ncol = 2,
  nrow = 2,
  common.legend = T,
  legend = 'right'
)
```

Statistical differences in mean squared error distributions between cell types.
(p-value rounded to 8 decimals)

